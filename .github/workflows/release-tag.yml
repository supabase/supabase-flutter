name: Create Release Tags

on:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  actions: write

jobs:
  create-tags:
    if: ${{ contains(github.event.head_commit.message, 'chore(release):') }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Generate token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          cache: true

      - name: Setup Melos
        uses: bluefireteam/melos-action@v3
        with:
          tag: true

      - name: Trigger package release workflows
        id: trigger_releases
        run: .github/scripts/trigger-package-releases.sh
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: Generate workflow summary
        if: always()
        run: |
          echo "## Release Tag Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.trigger_releases.outcome }}" == "success" ]; then
            echo "✅ **Status:** All package release workflows triggered successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Status:** Failed to trigger some package release workflows" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Error Details:**" >> $GITHUB_STEP_SUMMARY
            echo "Please check the logs for the 'Trigger package release workflows' step for more information." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.event.head_commit.message }}" >> $GITHUB_STEP_SUMMARY
          echo "**Ref:** ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY

  notify-success:
    name: Notify Slack on Success
    needs: create-tags
    if: ${{ needs.create-tags.result == 'success' }}
    uses: ./.github/workflows/slack-notify.yml
    secrets: inherit
    with:
      title: 'Release Tags Created'
      status: 'success'

  notify-failure:
    name: Notify Slack on Failure
    needs: create-tags
    if: ${{ always() && needs.create-tags.result == 'failure' }}
    uses: ./.github/workflows/slack-notify.yml
    secrets: inherit
    with:
      title: 'Release Tags Creation'
      status: 'failure'