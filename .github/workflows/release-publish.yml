name: Publish Packages

on:
  workflow_dispatch:

permissions:
  contents: write
  id-token: write

jobs:
  publish-packages:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Generate token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          cache: true

      - name: Publish to pub.dev
        id: publish
        uses: bluefireteam/melos-action@v3
        with:
          publish: true

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ## Package Release

            Released package: ${{ github.ref_name }}

            See the package CHANGELOG for detailed changes.

            ---
            *This release was created automatically by the Publish Packages workflow.*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: Generate workflow summary
        if: always()
        run: |
          echo "## Package Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.publish.outcome }}" == "success" ]; then
            echo "âœ… **Pub.dev Publishing:** Success" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Pub.dev Publishing:** Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.create_release.outcome }}" == "success" ]; then
            echo "âœ… **GitHub Release:** Success" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **GitHub Release:** Failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.publish.outcome }}" == "success" ] && [ "${{ steps.create_release.outcome }}" == "success" ]; then
            echo "ðŸŽ‰ Package published successfully!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Some steps failed. Please review the logs above." >> $GITHUB_STEP_SUMMARY
          fi
